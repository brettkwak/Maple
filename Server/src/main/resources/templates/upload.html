<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>코강 계산기</title>
    <meta charset="UTF-8">
    <style>
        .image-upload-container {
            width: 300px;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .image-upload-container:hover {
            background-color: #f0f0f0;
        }
        
        .plus-icon {
            font-size: 80px;
            color: #888;
            font-weight: lighter;
        }
        
        .upload-text {
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 100%;
            display: none;
            object-fit: contain;
        }
        
        #fileInput {
            display: none;
        }
        
        .form-group {
            margin: 10px 0;
        }
        
        /* Image preview container */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            max-width: 650px;
            max-height: 450px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
        }

        /* for each image preview */
        .image-preview-item {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: visible;
            margin: 10px;
        }

        .image-preview-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Remove image button */
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            font-size: 13px;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <h1>코어 강화 계산기</h1>
    
    <div th:if="${message}">
        <p th:text="${message}"></p>
    </div>
    
    <form method="POST" action="/upload" enctype="multipart/form-data">
        <!-- Image upload box with plus sign -->
        <div class="image-upload-container" id="uploadBox" onclick="document.getElementById('fileInput').click()">
            <div class="plus-icon">+</div>
            <p class="upload-text">이미지를 업로드하려면 클릭하세요</p>
            <img id="imagePreview" src="#" alt="Preview" />
        </div>
        <input type="file" id="fileInput" name="images" accept="image/*"/>
        
        <!-- Container to display all selected images -->
        <div class="image-preview-container" id="previewContainer"></div>


        <div class="form-group">
            <label for="setting">직업군:</label>
            <select name="setting" id="setting">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>

        <div class="form-group">
            <label for="setting">직업:</label>
            <select name="setting" id="setting">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>


        <div class="form-group">
            <label for="setting">중첩:</label>
            <select name="setting" id="setting">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>

        <div class="form-group">
            <label for="setting">코어 개수:</label>
            <select name="setting" id="setting">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>

        <div class="form-group">
            <label for="setting">이미지 개수:</label>
            <input type="number" name="setting" id="setting" min="1" max="4" value="2">
        </div>

        <button type="button" id="processButton">Process</button>

    </form>

    <script>
        // Store uploaded files
        let uploadedFiles = [];
        
        // Preview image when selected
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const preview = document.getElementById('imagePreview');
            const plusIcon = document.querySelector('.plus-icon');
            const uploadText = document.querySelector('.upload-text');
            
            if (event.target.files.length > 0) {
                const file = event.target.files[0];
                
                // Add to uploaded files array
                uploadedFiles.push(file);
                
                // Create preview for the selected image
                const previewUrl = URL.createObjectURL(file);
                
                // Show in main preview
                preview.src = previewUrl;
                preview.style.display = 'block';
                plusIcon.style.display = 'none';
                uploadText.style.display = 'none';
                
                // Add to preview container
                addImagePreview(previewUrl, uploadedFiles.length - 1);
                
                // Reset file input to allow selecting the same file again
                this.value = '';
                
                // Reset main preview after a short delay
                setTimeout(() => {
                    preview.style.display = 'none';
                    plusIcon.style.display = 'block';
                    uploadText.style.display = 'block';
                }, 1000);
            }
        });
        
        // Add image preview to container
        function addImagePreview(url, index) {
            const container = document.getElementById('previewContainer');
            
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = url;
            
            const removeButton = document.createElement('div');
            removeButton.className = 'remove-image';
            removeButton.innerHTML = '×';
            removeButton.onclick = function(e) {
                e.stopPropagation();
                removeImage(index);
            };
            
            previewItem.appendChild(img);
            previewItem.appendChild(removeButton);
            container.appendChild(previewItem);
        }
        
        // Remove image from preview and array
        function removeImage(index) {
            // Remove from array
            uploadedFiles.splice(index, 1);
            
            // Rebuild preview container
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';
            
            // Recreate all previews with updated indices
            uploadedFiles.forEach((file, i) => {
                const url = URL.createObjectURL(file);
                addImagePreview(url, i);
            });
        }
        
        // Process button click handler
        document.getElementById('processButton').addEventListener('click', function() {
            if (uploadedFiles.length === 0) {
                alert('이미지를 하나 이상 업로드해주세요.');
                return;
            }
            
            // Create FormData object
            const formData = new FormData(document.getElementById('uploadForm'));
            
            // Remove any existing file inputs
            formData.delete('images');
            
            // Add all uploaded files
            uploadedFiles.forEach(file => {
                formData.append('images', file);
            });
            
            // Submit the form
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                // Redirect or handle response
                window.location.href = '/results';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('업로드 중 오류가 발생했습니다.');
            });
        });
    </script>


</body>
</html>
